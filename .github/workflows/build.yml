name: Build and Commit OoT3D Freecam Patches

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build All Regions (3DS + Citra)

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install dependencies: devkitPro, devkitARM, python3
      - name: Install devkitPro toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y wget git make python3 bash
          wget https://apt.devkitpro.org/install-devkitpro-pacman
          chmod +x install-devkitpro-pacman
          sudo ./install-devkitpro-pacman
          sudo dkp-pacman -Sy --noconfirm 3ds-dev

      # Step 3: Set environment
      - name: Set environment variables
        run: |
          echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
          echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV
          echo "PATH=$PATH:/opt/devkitpro/devkitARM/bin" >> $GITHUB_ENV

      # Step 4: Make sure patch.py is executable
      - name: Ensure patch.py is executable
        run: chmod +x patch.py

      # Step 5: Run the all-region build script
      - name: Run makeAll.sh to build and generate IPS patches
        run: |
          chmod +x makeAll.sh
          ./makeAll.sh
        env:
          DEVKITPRO: /opt/devkitpro
          DEVKITARM: /opt/devkitpro/devkitARM
          PYTHON: python3

      # Step 6: Show generated patch files
      - name: List generated patch files
        run: |
          echo "Generated patch files:"
          find "Patch Files" -type f -name "*.ips" || true

      # Step 7: Commit and push generated patch files
      - name: Commit and push build outputs
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "Patch Files/"
          git commit -m "Automated rebuild of patch files [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref }}
